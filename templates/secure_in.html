  <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport" 
content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Gate Entry (IN) | Faculty Portal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/responsive.css">

    <style>
        :root {
            --primary: #1A73E8;
            --sidebar-bg: #ffffff;
            --main-bg: #f8f9fa;
            --text-dark: #202124;
            --text-light: #5f6368;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--main-bg); margin: 0; display: flex; overflow-x: hidden; }

        /* Layout */
        .sidebar { width: 260px; height: 100vh; background: var(--sidebar-bg); border-right: 1px solid #e0e0e0; position: fixed; top: 0; z-index: 1000; }
        .sidebar-header { padding: 25px; font-size: 22px; font-weight: bold; color: var(--primary); border-bottom: 1px solid #f1f3f4; }
        .menu-item { padding: 14px 25px; display: flex; align-items: center; gap: 15px; color: var(--text-light); text-decoration: none; font-weight: 500; transition: 0.3s; }
        .menu-item.active { background: #e8f0fe; color: var(--primary); border-left: 5px solid var(--primary); }

        .main-content { margin-left: 260px; width: calc(100% - 260px); min-height: 100vh; }
        .top-header { background: white; padding: 12px 40px; display: flex; justify-content: flex-end; align-items: center; gap: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .content-body { padding: 30px 40px; }
        .page-title { font-size: 26px; font-weight: bold; color: var(--text-dark); margin: 0; }
        .page-tagline { color: var(--text-light); font-size: 15px; margin: 8px 0 25px; }

        /* Selection Bar */
        .selection-container { display: flex; gap: 15px; margin-bottom: 25px; }
        .input-card { background: #fff; border: 1px solid #dadce0; border-radius: 10px; padding: 10px 15px; display: flex; flex-direction: column; flex: 1; box-shadow: var(--shadow); }
        .input-card label { font-size: 13px; font-weight: 600; color: #444; margin-bottom: 4px; }
        .input-card input, .input-card select { border: none; outline: none; font-size: 15px; font-weight: 500; background: transparent; color: var(--text-dark); width: 100%; }

        /* Attendance Area */
        .attendance-grid { display: flex; gap: 25px; align-items: stretch; }
        .camera-box { flex: 2; background: white; border-radius: 20px; box-shadow: var(--shadow); padding: 20px; text-align: center; position: relative; }

        /* Container for Video + Overlay */
       .video-container {
  position: relative;
  width: 100%;
  max-width: 640px;
  aspect-ratio: 4/3;
  margin: 0 auto;
  border-radius: 12px;
  background: #000;
  border: 2px solid #dadce0;
  overflow: hidden;
}


        video {
           width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
           transform: scaleX(-1); /* వీడియోని మిర్రర్ చేస్తుంది */
        }

        #overlay-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10;
        }

        #scanning-indicator {
            position: absolute;
            top: 35px;
            left: 35px;
            background: #34A853;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            display: none;
            z-index: 10;
        }

        .controls { margin-top: 15px; }
        .btn { padding: 12px 40px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 15px; display: inline-flex; align-items: center; gap: 10px; transition: 0.3s; }
        .btn-start { background: #34A853; color: white; }
        .btn-stop { background: #D93025; color: white; display: none; }

        .log-box { flex: 1; background: white; border-radius: 20px; box-shadow: var(--shadow); padding: 25px; display: flex; flex-direction: column; max-height: 580px; }
        .log-box h4 { margin: 0 0 15px; font-size: 17px; color: var(--text-dark); border-bottom: 1px solid #f1f3f4; padding-bottom: 10px; }
        #log-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        #log-list li { padding: 10px 0; border-bottom: 1px solid #f8f9fa; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
        .log-success { color: #1e8e3e; font-weight: bold; }
        .log-error { color: #d93025; }

        #scan-popup { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); padding: 15px 30px; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 100; display: none; font-weight: bold; font-size: 17px; border-top: 4px solid; }

        @media (max-width:768px){
  .attendance-grid{
    flex-direction:column;
  }
}

    </style>
</head>
<body>
<div id="sidebarOverlay"></div>


    <div class="sidebar">
        <div class="sidebar-header">Faculty Portal</div>
        <div class="sidebar-menu">
    <a href="/faculty_dashboard" class="menu-item"><i class="bi bi-columns-gap"></i> Dashboard</a>
    <a href="/register" class="menu-item"><i class="bi bi-person-plus"></i> Student Registration</a>
    <a href="/edit_student_search" class="menu-item"><i class="bi bi-pencil-square"></i> Edit Student Profile</a>
    
    <a href="/secure_in" class="menu-item active"><i class="bi bi-camera-video"></i> Start Entry (IN)</a>
    
    <a href="/secure_out" class="menu-item"><i class="bi bi-door-open"></i> Start Exit (OUT)</a>
    <a href="/attendance_reports" class="menu-item"><i class="bi bi-file-earmark-bar-graph"></i> Attendance Reports</a>
    <a href="/manage_students" class="menu-item"><i class="bi bi-people"></i> Manage Students</a>
    <a href="/logout" class="menu-item" style="margin-top: auto; color: #d93025;"><i class="bi bi-power"></i> Logout</a>
</div>
    </div>

    <div class="main-content">
        <div class="top-header">
            <button id="menuToggle" class="hamburger">☰</button>

            <div style="font-weight: 500;">Admin Faculty</div>
            <a href="/logout" style="margin-left:15px; color: #d93025; text-decoration: none; font-weight: 600;">Logout</a>
        </div>

        <div class="content-body">
            <h2 class="page-title">Gate Entry (IN) Monitoring</h2>
            <p class="page-tagline">Start the session to allow students to mark their attendance for entry.</p>

            <div class="selection-container">
                <div class="input-card">
                    <label>Year</label>
                    <select id="f_year">
                        <option value="1">1st Year</option>
                        <option value="2">2nd Year</option>
                        <option value="3">3rd Year</option>
                        <option value="4">4th Year</option>
                    </select>
                </div>
                <div class="input-card">
                    <label>Branch</label>
                    <input type="text" id="f_branch" placeholder="EX: CSE" style="text-transform: uppercase;">
                </div>
                <div class="input-card">
                    <label>Section</label>
                    <input type="text" id="f_section" placeholder="EX: A" style="text-transform: uppercase;">
                </div>
                <div class="input-card" style="flex: 1.5;">
                    <label>Subject / Period Name</label>
                    <input type="text" id="subjectInput" placeholder="Enter Subject Name">
                </div>
                <div class="input-card">
                    <label>Period</label>
                    <select id="periodInput">
                        <option value="P1-P2">1 & 2</option>
                        <option value="P3-P4">3 & 4</option>
                        <option value="P5-P6">5 & 6</option>
                        <option value="P7-P8">7 & 8</option>
                    </select>
                </div>
            </div>

            <div class="attendance-grid">
                <div class="camera-box">
                    <div id="scanning-indicator">SCANNING ACTIVE</div>
                    <div id="scan-popup"></div>
                    
                    <div class="video-container">
                        <video id="webcam" autoplay playsinline muted></video>
                        <canvas id="overlay-canvas"></canvas>
                    </div>

                    <canvas id="hidden-canvas" style="display:none;"></canvas>

                    <div class="controls">
                        <button id="startBtn" class="btn btn-start" onclick="startAttendance()">
                            Start IN Scanning
                        </button>
                        <button id="stopBtn" class="btn btn-stop" onclick="stopAttendance()">
                            Stop Scanning
                        </button>
                    </div>
                </div>

                <div class="log-box">
                    <h4>Recent Activity</h4>
                    <ul id="log-list">
                        <li style="color: #999; text-align: center;">No activity yet</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>

let lastRecognized = null;
let lastRecognizedTime = 0;
let stableRegNo = null;
let stableCount = 0;
const STABLE_REQUIRED = 2;

let ignoreUnknownUntil = 0;


        function utcToIST(timeStr) {
    if (!timeStr || !timeStr.includes(":")) return timeStr;

    const parts = timeStr.split(":").map(Number);
    const d = new Date();
    d.setUTCHours(parts[0], parts[1], parts[2] || 0);

    return d.toLocaleTimeString("en-IN", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit"
    });
}

        let stream = null;
        let isScanning = false;
        let scanInterval = null;
        let lastSent = 0;


        async function startAttendance() {
            const subject = document.getElementById('subjectInput').value.trim();
            const branch = document.getElementById('f_branch').value.trim();
            const section = document.getElementById('f_section').value.trim();
            if (!subject || !branch || !section) { alert("Please fill all details!"); return; }

            try {
                await fetch('/api/toggle_attendance/IN/start');
                stream = await navigator.mediaDevices.getUserMedia({
  video: {
    facingMode: "user",
    width: { ideal: 480 },
    height: { ideal: 360 },
    frameRate: { ideal: 24 }
  },
  audio: false
});

                const video = document.getElementById('webcam');
                video.srcObject = stream;

                video.onloadedmetadata = () => {
                  video.play();
                 };
                
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'inline-flex';
                document.getElementById('scanning-indicator').style.display = 'block';
                
                isScanning = true;
                scanInterval = setInterval(processAttendance, 500); 
                addLogEntry(`Session Started: ${subject}`, 'info');
            } catch (err) { alert("Camera Permission Denied!"); }
        }

        async function processAttendance() {
            
    if (!isScanning) return; 

    // Skip duplicate frames (Step 4)
if (Date.now() - lastSent < 500) return;
lastSent = Date.now();
    
    const video = document.getElementById('webcam');

    if (!video.videoWidth) return;

    const hiddenCanvas = document.getElementById('hidden-canvas');
    hiddenCanvas.width = video.videoWidth;
    hiddenCanvas.height = video.videoHeight;
    hiddenCanvas.getContext('2d').drawImage(video, 0, 0, hiddenCanvas.width, hiddenCanvas.height);

    const payload = {
        image: hiddenCanvas.toDataURL('image/jpeg', 0.75),
        mode: 'IN', 
        subject: document.getElementById('subjectInput').value,
        period: document.getElementById('periodInput').value,
        year: document.getElementById('f_year').value,
        branch: document.getElementById('f_branch').value.toUpperCase(),
        section: document.getElementById('f_section').value.toUpperCase()
    };

    try {
        const response = await fetch('/api/mark_attendance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const result = await response.json();
        
        if (result.success && result.results) {
            drawBoxes(result.results);
            // ✅ If any known face exists, ignore unknowns in this frame
const hasKnown = result.results.some(r => r.reg_no && r.reg_no !== "Unknown");

            result.results.forEach(res => {

    // ✅ HANDLE KNOWN FACE
    if (res.reg_no && res.reg_no !== "Unknown") {

        if (stableRegNo === res.reg_no) {
            stableCount++;
        } else {
            stableRegNo = res.reg_no;
            stableCount = 1;
        }

        if (stableCount >= STABLE_REQUIRED) {

            lastRecognized = res.reg_no;
            lastRecognizedTime = Date.now();
            ignoreUnknownUntil = Date.now() + 4000;

            let fixedStatus = res.status;

            const timeMatch = res.status.match(/\d{2}:\d{2}:\d{2}/);
            if (timeMatch) {
                const istTime = utcToIST(timeMatch[0]);
                fixedStatus = res.status.replace(timeMatch[0], istTime);
            }

            addLogEntry(`Present: ${res.reg_no}`, 'success');

            stableCount = 0;
        }
    }

    // ✅ HANDLE UNKNOWN
    else if (res.reg_no === "Unknown") {

    if (hasKnown) return; // ignore unknown if known exists

    if (Date.now() < ignoreUnknownUntil) return;

    addLogEntry("Unknown Face", 'error');
}


});

        } else {
            clearOverlay();
        }
    } catch (e) { 
        console.error("Attendance Process Error:", e);
    }
}

        // బాక్సులను గీయడానికి ఈ ఫంక్షన్ కచ్చితంగా ఉండాలి
function drawBoxes(results) {
    const canvas = document.getElementById('overlay-canvas');
    const video = document.getElementById('webcam');
    const ctx = canvas.getContext('2d');
    
    // బాక్సులు సరిగ్గా సెట్ అవ్వడానికి ఇది ముఖ్యం
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    results.forEach(face => {
        const [x1, y1, x2, y2] = face.box;
        const width = x2 - x1;
        const height = y2 - y1;

        // మిర్రర్ ఎఫెక్ట్ ని అడ్జస్ట్ చేయడం
        const mirroredX1 = canvas.width - x2;

        ctx.strokeStyle = face.color || 'red';
        ctx.lineWidth = 4;
        
        // బాక్స్ గీయడం
        ctx.strokeRect(mirroredX1, y1, width, height);

        // టెక్స్ట్ కోసం రంగు
        ctx.fillStyle = face.color || 'red';
        ctx.font = "bold 18px Arial";
        
        // రిజిస్టర్ నంబర్ పైన
        ctx.fillText(face.reg_no, mirroredX1, y1 - 10);

        // స్టేటస్ కింద
        ctx.font = "bold 14px Arial";
        ctx.fillText("Status: " + face.status, mirroredX1, y2 + 25);
    });
}

        function clearOverlay() {
            const canvas = document.getElementById('overlay-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function addLogEntry(msg, type) {
            const list = document.getElementById('log-list');
            if (list.innerHTML.includes("No activity")) list.innerHTML = "";
            
            // Prevent spam for the same student/status in the same second
            if (list.firstChild && list.firstChild.innerText.includes(msg)) return;

            const li = document.createElement('li');
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            li.innerHTML = `<span>${msg}</span> <span style="color:#999; font-size:12px;">${time}</span>`;
            if (type === 'success') li.classList.add('log-success');
            if (type === 'error') li.classList.add('log-error');
            list.prepend(li);
            
            if (list.children.length > 15) list.removeChild(list.lastChild);
        }

        async function stopAttendance() {
            isScanning = false; 
            clearInterval(scanInterval);
            clearOverlay();
            if (stream) stream.getTracks().forEach(t => t.stop());

            try {
   await fetch('/api/toggle_attendance/IN/stop');
} catch(e){
   console.log("Stop API skipped");
}

             // UI reset instead of reload
          document.getElementById('startBtn').style.display = 'inline-flex';
          document.getElementById('stopBtn').style.display = 'none';
          document.getElementById('scanning-indicator').style.display = 'none';

          // ✅ Clear all fields
document.getElementById('subjectInput').value = "";
document.getElementById('f_branch').value = "";
document.getElementById('f_section').value = "";
document.getElementById('periodInput').selectedIndex = 0;
document.getElementById('f_year').selectedIndex = 0;

// reset stability tracking
stableRegNo = null;
stableCount = 0;
lastRecognized = null;
document.getElementById("webcam").srcObject = null;


        }

const toggle = document.getElementById("menuToggle");
const sidebar = document.querySelector(".sidebar");
const overlay = document.getElementById("sidebarOverlay");

toggle.addEventListener("click", ()=>{
  sidebar.classList.toggle("active");
  overlay.classList.toggle("active");
});

overlay.addEventListener("click", ()=>{
  sidebar.classList.remove("active");
  overlay.classList.remove("active");
});

document.querySelectorAll(".menu-item").forEach(item=>{
  item.addEventListener("click", ()=>{
    sidebar.classList.remove("active");
    overlay.classList.remove("active");
  });
});


    </script>
</body>
</html>