<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Registration | Faculty Portal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/responsive.css">

    <style>
        :root {
            --primary: #1A73E8;
            --sidebar-bg: #ffffff;
            --main-bg: #f8f9fa;
            --text-dark: #202124;
            --text-light: #5f6368;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #e3f2fd 100%);
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--main-bg); margin: 0; display: flex; }

        /* Sidebar & Layout */
        .sidebar { width: 260px; height: 100vh; background: var(--sidebar-bg); border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; position: fixed; left: 0; top: 0; z-index: 1000; }
        .sidebar-header { padding: 25px; font-size: 22px; font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #f1f3f4; }
        .sidebar-menu { padding: 20px 0; flex-grow: 1; }
        .menu-item { padding: 12px 25px; display: flex; align-items: center; gap: 15px; color: var(--text-light); text-decoration: none; font-weight: 500; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { background: #f1f3f4; color: var(--primary); border-left: 4px solid var(--primary); }

        .main-content { margin-left: 260px; width: calc(100% - 260px); min-height: 100vh; background: var(--bg-gradient); }
        .top-header { background: white; padding: 12px 40px; display: flex; justify-content: flex-end; align-items: center; gap: 20px; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 999; }

        /* Form Card */
        .content-container { display: flex; justify-content: center; align-items: center; padding: 30px; min-height: calc(100vh - 100px); }
        .reg-card { background: white; padding: 25px 35px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); width: 100%; max-width: 550px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 5px; }
        .input-group { flex: 1; margin-bottom: 12px; }
        label { display: block; font-size: 13px; color: #5f6368; margin-bottom: 4px; font-weight: 600; }
        input { width: 100%; padding: 10px; border: 1px solid #dadce0; border-radius: 8px; font-size: 14px; outline: none; box-sizing: border-box; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(26,115,232,0.1); }

        .btn-capture { background: var(--primary); color: white; border: none; padding: 14px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; display: flex; justify-content: center; align-items: center; gap: 10px; }

        .error-card { display: none; background: #fdecea; color: #d93025; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; border: 1px solid #f8d7da; text-align: center; }

        /* Camera Popup */
        #camera-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; }
        .camera-box { background: white; padding: 25px; border-radius: 20px; text-align: center; max-width: 450px; }
        video { border-radius: 12px; width: 100%; background: #000; transform: scaleX(-1); }
        .progress-bar { height: 8px; background: #eee; border-radius: 4px; margin: 20px 0 10px; overflow: hidden; }
        #progress-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.4s; }
        .status-msg { font-size: 14px; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header"><i class="bi bi-shield-check"></i> Faculty Portal</div>
        <div class="sidebar-menu">
            <a href="/faculty_dashboard" class="menu-item"><i class="bi bi-columns-gap"></i> Dashboard</a>
            <a href="/register" class="menu-item active"><i class="bi bi-person-plus"></i> Student Registration</a>
            <a href="/edit_student_search" class="menu-item"><i class="bi bi-pencil-square"></i> Edit Student Profile</a>
            <a href="/secure_in" class="menu-item"><i class="bi bi-camera-video"></i> Start Entry (IN)</a>
            <a href="/secure_out" class="menu-item"><i class="bi bi-door-open"></i> Start Exit (OUT)</a>
            <a href="/attendance_reports" class="menu-item"><i class="bi bi-file-earmark-bar-graph"></i> Attendance Reports</a>
            <a href="/manage_students" class="menu-item"><i class="bi bi-people"></i> Manage Students</a>
            <a href="/logout" class="menu-item" style="margin-top: auto; color: #d93025;"><i class="bi bi-power"></i> Logout</a>
        </div>
    </div>

    <div class="main-content">
        <div class="top-header">
            <button id="menuToggle" class="hamburger">â˜°</button>

            <div style="font-weight: 500;"><i class="bi bi-person-circle"></i> Admin Faculty</div>
            <a href="/logout" style="margin-left:20px; color: #d93025; text-decoration: none; font-weight: 600; font-size: 14px;"><i class="bi bi-power"></i> Logout</a>
        </div>

        <div class="content-container">
            <div class="reg-card">
                <div style="text-align: center; margin-bottom: 15px;">
                    <i class="bi bi-person-plus-fill" style="font-size: 32px; color: var(--primary);"></i>
                    <h3 style="margin: 5px 0;">Student Registration</h3>
                </div>
                <div id="error-card" class="error-card"></div>
                <div class="form-row">
                    <div class="input-group"><label>Full Name</label><input type="text" id="name" placeholder="Full Name"></div>
<div class="input-group">
    <label>Phone Number <span style="color:red;">*</span></label>
    <input type="text" id="phone" placeholder="10 Digit No" maxlength="10">
</div>                </div>
                <div class="form-row">
<div class="input-group">
    <label>Registration Number <span style="color:red;">*</span></label>
    <input type="text" id="reg_no" placeholder="e.g. 21B01A0501" maxlength="10" oninput="syncPassword()" style="text-transform: uppercase;">
</div>                   
 <div class="input-group"><label>Password</label><input type="text" id="password" readonly style="background: #f1f3f4; color: #5f6368;"></div>
                </div>
                <div class="input-group">
    <label><i class="bi bi-calendar-event"></i> Year</label>
    <select name="year" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd;">
        <option value="" disabled selected>Select Year</option>
        <option value="1">1st Year</option>
        <option value="2">2nd Year</option>
        <option value="3">3rd Year</option>
        <option value="4">4th Year</option>
    </select>
    </div>
                <div class="form-row">
                    <div class="input-group"><label>Branch</label><input type="text" id="branch" placeholder="Ex: CSE"></div>
                    <div class="input-group"><label>Section</label><input type="text" id="section" placeholder="Ex: A"></div>
                </div>
                <button class="btn-capture" onclick="validateAndOpenCamera()"><i class="bi bi-camera-fill"></i> Start Face Capture</button>
            </div>
        </div>
    </div>

    <div id="camera-overlay">
        <div class="camera-box">
            <h4 id="pose-instruction" style="margin-bottom:10px; color: var(--text-dark);">Starting Camera...</h4>
            <video id="webcam" autoplay playsinline></video>
            <div class="progress-bar"><div id="progress-fill"></div></div>
            <div id="capture-status" class="status-msg" style="color: var(--primary);">0/4 Poses Captured</div>

            <button onclick="closeCamera()" style="margin-top: 15px; color: #d93025; border: none; background: none; font-weight: bold; cursor: pointer;">Cancel</button>
        </div>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

   <script>
    fetch("/warmup");
function syncPassword() {
    const reg = document.getElementById("reg_no").value.toUpperCase().replace(/[^A-Z0-9]/g,"");
    document.getElementById("reg_no").value = reg;
    document.getElementById("password").value = reg;
}

function clearSecurityFields() {
    document.getElementById("reg_no").value = "";
    document.getElementById("password").value = "";
}

function showError(msg) {
    const err = document.getElementById("error-card");
    err.innerText = msg;
    err.style.display = "block";
    clearSecurityFields();
    setTimeout(() => err.style.display = "none", 5000);
}

async function validateAndOpenCamera() {
    const name = document.getElementById("name").value;
    const reg_no = document.getElementById("reg_no").value.toUpperCase();
    const phone = document.getElementById("phone").value;
    const year = document.querySelector("select[name='year']").value;

    if (!name || !reg_no || !phone || !year) {
        showError("Name, Reg No, Phone, and Year are all required!");
        return;
    }

    if (reg_no.length !== 10) {
        showError("Registration Number must be exactly 10 characters long!");
        return;
    }

    if (phone.length !== 10 || isNaN(phone)) {
        showError("Please enter a valid 10-digit Phone Number!");
        return;
    }

    const check = await fetch("/api/check_id", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ reg_no })
    });

    const res = await check.json();
    if (res.exists) {
        showError(reg_no + " already registered!");
        return;
    }

    openCamera();
}

let stream = null;
let captureCount = 0;
let autoTimer = null;
const TOTAL_CAPTURES = 20;

async function openCamera() {
    document.getElementById("camera-overlay").style.display = "flex";

    captureCount = 0;
    updateUI();

    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 1280, height: 720 }
        });

        const video = document.getElementById("webcam");
        video.srcObject = stream;

        // ðŸ”¥ Ensure video is actually playing before auto start
        video.onloadedmetadata = () => {
            video.play();
            startAutoCapture();   // <-- THIS was missing timing guarantee
        };

    } catch (err) {
        alert("Camera access denied!");
        closeCamera();
    }
}


function updateUI() {
    const pct = (captureCount / TOTAL_CAPTURES) * 100;
    document.getElementById("progress-fill").style.width = pct + "%";
    document.getElementById("capture-status").innerText = `Progress: ${captureCount}/${TOTAL_CAPTURES}`;

    // à°¯à±‚à°œà°°à± à°•à°¿ à°…à°°à±à°¥à°®à°¯à±à°¯à±‡ à°¸à±‚à°šà°¨à°²à±
    let msg = " Camera capturing 20 samples.\nOnly ONE person should be visible.";

if (captureCount > 10)
    msg = " Half done! Stay in front of camera.";

if (captureCount > 17)
    msg = " Almost finished. Hold still!";

document.getElementById("pose-instruction").innerText = msg;

}


function startAutoCapture() {
    if (autoTimer) return;
    autoTimer = setInterval(captureFace, 1000);
}

function stopAuto() {
    if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
    }
}

async function captureFace() {
    if (captureCount >= TOTAL_CAPTURES) return;

    const video = document.getElementById("webcam");
    if (!video.videoWidth) return;

    const canvas = document.getElementById("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);

    const imageData = canvas.toDataURL("image/jpeg", 0.9);

    try {
        const response = await fetch("/api/process_web_pose", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({
                name: document.getElementById("name").value,
                reg_no: document.getElementById("reg_no").value.toUpperCase(),
                year: document.querySelector("select[name='year']").value,
                phone: document.getElementById("phone").value,
                branch: document.getElementById("branch").value,
                section: document.getElementById("section").value,
                image: imageData
            })
        });

        const result = await response.json();

        if (result.hard_stop) {
    stopAuto();
    alert(result.message);
    closeCamera();
    return;
}


        if (!result.success) {
            document.getElementById("pose-instruction").innerText =
                result.message || "Adjust your face position";
            return;
        }

        // increment ONLY when backend accepts
        if (result.count !== undefined) {
          captureCount = result.count;
          updateUI();
   } else {
    captureCount++;
    updateUI();
}


        if (result.completed) {
             // ðŸ”¥ Force final UI update before closing
    captureCount = TOTAL_CAPTURES;
    updateUI();

    stopAuto();
    autoTimer = null;       // ðŸ”¥ FORCE NULL
    
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }

    document.getElementById("camera-overlay").style.display = "none";

    setTimeout(() => {
        closeCamera();
        alert("Registration successful!");
        window.location.href = "/faculty_dashboard";
    }, 300);
        }

    } catch (e) {
        console.error("AUTO CAPTURE ERROR:", e);
    }
}

function closeCamera() {
    stopAuto();

    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }

    document.getElementById("camera-overlay").style.display = "none";
    captureCount = 0;
    updateUI();
}

// Safety: tab switch
document.addEventListener("visibilitychange", function () {
    if (document.hidden) {
        const reg_no = document.getElementById("reg_no").value;
        if (reg_no) {
            fetch("/api/clear_temp_registration", {
                method: "POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ reg_no: reg_no.toUpperCase() })
            });
        }

        if (stream) {
            alert("Tab switched! Registration reset.");
            window.location.reload();
        }
    }
});

const toggle = document.getElementById("menuToggle");
const sidebar = document.querySelector(".sidebar");

toggle.addEventListener("click", ()=>{
  sidebar.classList.toggle("active");
});
</script>

</body>
</html>