<!DOCTYPE html>
<html>
<head>
    <title>Attendance Reports | Faculty Portal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root { 
            --primary: #1A73E8; 
            --sidebar-bg: #ffffff;
            --main-bg: #f8f9fa;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #e3f2fd 100%);
            --text-dark: #202124;
            --text-light: #5f6368;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        body { font-family: 'Segoe UI', sans-serif; background: var(--main-bg); margin: 0; display: flex; }

        /* Sidebar Style */
        .sidebar { width: 260px; height: 100vh; background: var(--sidebar-bg); border-right: 1px solid #e0e0e0; position: fixed; display: flex; flex-direction: column; z-index: 1000; }
        .sidebar-header { padding: 25px; font-size: 22px; font-weight: bold; color: var(--primary); border-bottom: 1px solid #f1f3f4; }
        .sidebar-menu { padding: 20px 0; flex-grow: 1; }
        .menu-item { padding: 12px 25px; display: flex; align-items: center; gap: 15px; color: var(--text-light); text-decoration: none; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: #f1f3f4; color: var(--primary); border-left: 4px solid var(--primary); }

        /* Main Content & Header */
        .main-content { margin-left: 260px; width: calc(100% - 260px); min-height: 100vh; background: var(--bg-gradient); }
        .top-header { background: white; padding: 15px 40px; display: flex; justify-content: flex-end; align-items: center; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 999; }

        .content-container { padding: 40px; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        /* Tabs & Table */
        .tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab { padding: 10px 20px; cursor: pointer; font-weight: 600; color: #5f6368; transition: 0.3s; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: var(--text-light); font-weight: 600; }
        
        .btn-export { background: #1e8e3e; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .btn-export:hover { background: #187031; }

        .status-absent { color: #d93025; font-weight: 500; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header"><i class="bi bi-shield-check"></i> Faculty Portal</div>
        <div class="sidebar-menu">
            <a href="/faculty_dashboard" class="menu-item"><i class="bi bi-columns-gap"></i> Dashboard</a>
            <a href="/register" class="menu-item"><i class="bi bi-person-plus"></i> Student Registration</a>
            <a href="/attendance_reports" class="menu-item active"><i class="bi bi-file-earmark-bar-graph"></i> Attendance Reports</a>
            <a href="/manage_students" class="menu-item"><i class="bi bi-people"></i> Manage Students</a>
            <a href="/logout" class="menu-item" style="margin-top: auto; color: #d93025;"><i class="bi bi-power"></i> Logout</a>
        </div>
    </div>

    <div class="main-content">
        <div class="top-header">
            <div style="font-weight: 500;"><i class="bi bi-person-circle"></i> Admin Faculty</div>
        </div>

        <div class="content-container">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <div>
                        <h2 style="margin: 0;">Attendance Reports</h2>
                        <p style="color: var(--text-light); margin: 5px 0;">Track daily student presence and absence</p>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <form action="/attendance_reports" method="GET">
                            <input type="date" id="datePicker" name="date" value="{{ date }}" onchange="this.form.submit()" 
                                   style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; outline: none;">
                        </form>
                        <button class="btn-export" onclick="exportTableToCSV('attendance_{{date}}.csv')">
                            <i class="bi bi-file-earmark-spreadsheet"></i> Export
                        </button>
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab active" id="present-tab" onclick="showTab('present')">Present ({{ present|length }})</div>
                    <div class="tab" id="absent-tab" onclick="showTab('absent')">Absent ({{ absent|length }})</div>
                </div>

                <div id="present-table-container">
                    <table>
                        <thead><tr><th>Reg No</th><th>Name</th><th>Branch</th><th>Section</th><th>In Time</th></tr></thead>
                        <tbody>
                            {% for p in present %}
                            <tr><td>{{ p[0] }}</td><td>{{ p[1] }}</td><td>{{ p[2] }}</td><td>{{ p[3] }}</td><td>{{ p[4] }}</td></tr>
                            {% endfor %}
                            {% if not present %}<tr><td colspan="5" style="text-align:center; padding: 20px;">No records found for this date.</td></tr>{% endif %}
                        </tbody>
                    </table>
                </div>

                <div id="absent-table-container" style="display: none;">
                    <table>
                        <thead><tr><th>Reg No</th><th>Name</th><th>Branch</th><th>Section</th><th>Phone</th></tr></thead>
                        <tbody class="status-absent">
                            {% for a in absent %}
                            <tr><td>{{ a[0] }}</td><td>{{ a[1] }}</td><td>{{ a[2] }}</td><td>{{ a[3] }}</td><td>{{ a[4] }}</td></tr>
                            {% endfor %}
                            {% if not absent %}<tr><td colspan="5" style="text-align:center; padding: 20px; color: #1e8e3e;">All students are present!</td></tr>{% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Future dates block chese logic
        document.addEventListener("DOMContentLoaded", function() {
            const dateInput = document.getElementById('datePicker');
            const today = new Date().toISOString().split('T')[0];
            dateInput.setAttribute('max', today);
        });

        function showTab(type) {
            const pTab = document.getElementById('present-tab');
            const aTab = document.getElementById('absent-tab');
            const pTable = document.getElementById('present-table-container');
            const aTable = document.getElementById('absent-table-container');

            if(type === 'present') {
                pTab.classList.add('active'); aTab.classList.remove('active');
                pTable.style.display = 'block'; aTable.style.display = 'none';
            } else {
                aTab.classList.add('active'); pTab.classList.remove('active');
                pTable.style.display = 'none'; aTable.style.display = 'block';
            }
        }

        function exportTableToCSV(filename) {
            let csv = [];
            // Ippudu screen meeda ఏ టేబుల్ కనిపిస్తుందో దాని డేటా మాత్రమే ఎక్స్‌పోర్ట్ అవుతుంది
            let activeTable = document.querySelector('#present-table-container').style.display !== 'none' 
                               ? '#present-table-container table' 
                               : '#absent-table-container table';
            
            let rows = document.querySelectorAll(activeTable + " tr");
            
            for (let i = 0; i < rows.length; i++) {
                let row = [], cols = rows[i].querySelectorAll("td, th");
                for (let j = 0; j < cols.length; j++) row.push('"' + cols[j].innerText + '"');
                csv.push(row.join(","));
            }
            
            let csvFile = new Blob([csv.join("\n")], {type: "text/csv"});
            let downloadLink = document.createElement("a");
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
        }
    </script>
</body>
</html>